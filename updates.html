<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title id="page-title">STaTbS21D - Live Updates</title>
    <meta name="description" content="Synoptic Edition of Book of the Dead Spell Sources from the 21st Dynasty (STaTbS21D) is a Digital Humanities project on Egyptology">
    
    <!-- Remove Elfsight script from here - we'll handle Facebook feed differently -->
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
        }
        
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #loader.hidden {
            display: none;
        }
        
        #content {
            width: 100%;
            height: 100%;
            display: none;
        }
        
        #content.visible {
            display: block;
        }
        
        #live-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .error-message {
            display: none;
            padding: 20px;
            text-align: center;
            color: #d32f2f;
        }
        
        /* Facebook feed styling */
        #facebook-feed-overlay {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 340px;
            max-height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 10000;
            display: none;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        .feed-header {
            padding: 16px;
            background: #1877f2;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
        }
        
        .close-feed {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .feed-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 16px;
        }
        
        .feed-item {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .feed-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        .feed-image {
            width: 100%;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .feed-message {
            font-size: 14px;
            line-height: 1.4;
            color: #333;
            margin-bottom: 8px;
        }
        
        .feed-date {
            font-size: 12px;
            color: #666;
        }
        
        .feed-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1877f2;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
    </style>
</head>

<body>
    <div id="loader">
        <div style="text-align: center;">
            <img src="assets/img/loading.gif" alt="Loading..." style="display: block;margin: auto;">
            <p>Loading...</p>
        </div>
    </div>

    <div class="error-message" id="error-message">
        <h3>Connection Error</h3>
        <p>Unable to load the content. Please check your connection and try again.</p>
        <button onclick="retryLoad()">Retry</button>
    </div>

    <div id="content">
        <!-- Iframe will be placed here -->
    </div>

    <!-- Facebook Feed Toggle Button -->
    <button class="feed-toggle" onclick="toggleFacebookFeed()">f</button>

    <!-- Custom Facebook Feed Overlay -->
    <div id="facebook-feed-overlay">
        <div class="feed-header">
            <span>Facebook Updates</span>
            <button class="close-feed" onclick="toggleFacebookFeed()">Ã—</button>
        </div>
        <div class="feed-content" id="feed-content">
            <div style="text-align: center; padding: 20px; color: #666;">
                <p>Loading Facebook feed...</p>
            </div>
        </div>
    </div>

    <script>
        // Pure JavaScript implementation
        let currentIframe = null;
        const targetDomain = 'https://statbs21d.github.io';
        
        // Sample Facebook feed data - you would replace this with actual API calls
        const sampleFeedData = [
            {
                message: "New research paper published on 21st Dynasty Book of the Dead artifacts",
                image: "https://via.placeholder.com/300x200/1877f2/ffffff?text=Research+Update",
                date: "2 hours ago"
            },
            {
                message: "Join our upcoming webinar on Egyptian papyri conservation techniques",
                image: "https://via.placeholder.com/300x200/25d366/ffffff?text=Webinar+Alert",
                date: "1 day ago"
            },
            {
                message: "Digital archive now updated with 50+ new high-resolution scans",
                image: "https://via.placeholder.com/300x200/ff4081/ffffff?text=Archive+Update",
                date: "3 days ago"
            }
        ];
        
        function init() {
            console.log('Initializing iframe...');
            
            // Hide loader and show content
            const loader = document.getElementById('loader');
            const content = document.getElementById('content');
            const errorMessage = document.getElementById('error-message');
            
            // Create iframe
            currentIframe = document.createElement('iframe');
            currentIframe.id = 'live-iframe';
            currentIframe.src = 'http://localhost/egiptologia.cu/statbs21d/manager/public.php';
            
            // Add sandbox permissions to allow more functionality but maintain security
            currentIframe.sandbox = "allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox";
            
            // Handle iframe load events
            currentIframe.onload = function() {
                console.log('Iframe loaded successfully');
                loader.classList.add('hidden');
                content.classList.add('visible');
                errorMessage.style.display = 'none';
                
                // Initialize Facebook feed
                initializeFacebookFeed();
                
                // Handle any external widgets in iframe
                handleExternalWidgets();
            };
            
            currentIframe.onerror = function() {
                console.error('Iframe failed to load');
                loader.classList.add('hidden');
                errorMessage.style.display = 'block';
            };
            
            content.appendChild(currentIframe);
        }
        
        function initializeFacebookFeed() {
            // Load sample feed data
            renderFacebookFeed(sampleFeedData);
            
            // In a real implementation, you would fetch from Facebook Graph API
            // fetchFacebookFeed();
        }
        
        function renderFacebookFeed(posts) {
            const feedContent = document.getElementById('feed-content');
            
            if (!posts || posts.length === 0) {
                feedContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;"><p>No posts available</p></div>';
                return;
            }
            
            let feedHTML = '';
            posts.forEach(post => {
                feedHTML += `
                    <div class="feed-item">
                        ${post.image ? `<img src="${post.image}" alt="Post image" class="feed-image" onerror="this.style.display='none'">` : ''}
                        <div class="feed-message">${post.message}</div>
                        <div class="feed-date">${post.date}</div>
                    </div>
                `;
            });
            
            feedContent.innerHTML = feedHTML;
        }
        
        function toggleFacebookFeed() {
            const feedOverlay = document.getElementById('facebook-feed-overlay');
            const isVisible = feedOverlay.style.display === 'block';
            
            if (isVisible) {
                feedOverlay.style.display = 'none';
            } else {
                feedOverlay.style.display = 'block';
                // Refresh feed when opened
                initializeFacebookFeed();
            }
        }
        
        function handleExternalWidgets() {
            try {
                // Remove any problematic external widgets from iframe
                setTimeout(() => {
                    const iframeDoc = currentIframe.contentDocument || currentIframe.contentWindow.document;
                    
                    // Remove Elfsight widgets and scripts from iframe
                    const elfSightScripts = iframeDoc.querySelectorAll('script[src*="elfsight"]');
                    elfSightScripts.forEach(script => script.remove());
                    
                    const elfSightWidgets = iframeDoc.querySelectorAll('[class*="elfsight"], [data-elfsight-app]');
                    elfSightWidgets.forEach(widget => {
                        widget.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Facebook feed available in the bottom-right corner</div>';
                    });
                    
                    // Also clean up any Facebook iframes that might cause blocking
                    const facebookIframes = iframeDoc.querySelectorAll('iframe[src*="facebook"]');
                    facebookIframes.forEach(frame => {
                        frame.style.display = 'none';
                    });
                    
                }, 1000);
            } catch (error) {
                console.log('Cannot modify iframe content due to cross-origin restrictions');
            }
        }
        
        // Real implementation for fetching Facebook feed (commented out as it requires API tokens)
        /*
        async function fetchFacebookFeed() {
            try {
                // You would need to set up a server-side proxy or use Facebook Graph API
                // This is a placeholder for the actual implementation
                const response = await fetch('/api/facebook-feed');
                const posts = await response.json();
                renderFacebookFeed(posts);
            } catch (error) {
                console.error('Failed to fetch Facebook feed:', error);
                // Fall back to sample data
                renderFacebookFeed(sampleFeedData);
            }
        }
        */
        
        // Listen for messages from iframe
        window.addEventListener('message', function(event) {
            if (event.data.type === 'NAVIGATE') {
                console.log('Navigation requested:', event.data.url);
                window.location.href = event.data.url;
            }
        });
        
        function retryLoad() {
            const loader = document.getElementById('loader');
            const errorMessage = document.getElementById('error-message');
            const content = document.getElementById('content');
            
            errorMessage.style.display = 'none';
            loader.classList.remove('hidden');
            content.classList.remove('visible');
            
            if (currentIframe && currentIframe.parentNode) {
                currentIframe.parentNode.removeChild(currentIframe);
            }
            
            setTimeout(init, 500);
        }
        
        // Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // CSS animation for loader
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>