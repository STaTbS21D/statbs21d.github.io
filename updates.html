<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title id="page-title">STaTbS21D - Live Updates</title>
    <meta name="description" content="Synoptic Edition of Book of the Dead Spell Sources from the 21st Dynasty (STaTbS21D) is a Digital Humanities project on Egyptology">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
        }
        
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #loader.hidden {
            display: none;
        }
        
        #content {
            width: 100%;
            height: 100%;
            display: none;
        }
        
        #content.visible {
            display: block;
        }
        
        #live-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .error-message {
            display: none;
            padding: 20px;
            text-align: center;
            color: #d32f2f;
        }
        
    </style>
</head>

<body>
    <div id="loader">
        <div style="text-align: center;">
            <img src="assets/img/loading.gif" alt="Loading..." style="display: block;margin: auto;">
            <p>Loading...</p>
        </div>
    </div>

    <div class="error-message" id="error-message">
        <h3>Connection Error</h3>
        <p>Unable to load the content. Please check your connection and try again.</p>
        <button onclick="retryLoad()">Retry</button>
    </div>

    <div id="content">
        <!-- Iframe will be placed here -->
    </div>

    <script>
    let currentIframe = null;
    const targetDomain = 'https://statbs21d.github.io';
    const iframeDomain = 'https://mdc2unicode.x10.bz';
    
    function init() {
        console.log('Initializing iframe...');
        
        const loader = document.getElementById('loader');
        const content = document.getElementById('content');
        const errorMessage = document.getElementById('error-message');
        
        currentIframe = document.createElement('iframe');
        currentIframe.id = 'live-iframe';
        currentIframe.src = 'https://mdc2unicode.x10.bz/statbs21d/public.php';
        
        currentIframe.onload = function() {
            console.log('Iframe loaded successfully');
            if (loader) loader.classList.add('hidden');
            if (content) content.classList.add('visible');
            if (errorMessage) errorMessage.style.display = 'none';
            
            setupCrossOriginLinkHandling();
        };
        
        currentIframe.onerror = function() {
            console.error('Iframe failed to load');
            if (loader) loader.classList.add('hidden');
            if (errorMessage) errorMessage.style.display = 'block';
        };
        
        if (content) content.appendChild(currentIframe);
    }
    
    function setupCrossOriginLinkHandling() {
        console.log('Cross-origin iframe loaded - relying on postMessage for navigation');
        //addInfoOverlay();
    }
    
    function handleNavigation(url) {
        try {
            const parsedUrl = new URL(url);
            
            if (parsedUrl.hostname === 'statbs21d.github.io' || 
                url.startsWith('/') || 
                (!url.includes('://') && !url.startsWith('mailto:') && !url.startsWith('tel:') && !url.startsWith('javascript:') && !url.startsWith('#'))) {
                
                let absoluteUrl = url;
                
                if (url.startsWith('/')) {
                    absoluteUrl = targetDomain + url;
                } else if (!url.includes('://')) {
                    absoluteUrl = targetDomain + '/' + url;
                }
                
                console.log('Navigating main window to:', absoluteUrl);
                window.location.href = absoluteUrl;
                return true;
            }
        } catch (error) {
            console.log('Error parsing URL:', error);
        }
        return false;
    }
    
    window.addEventListener('message', function(event) {
        console.log('Message received from iframe:', event.data);
        
        switch (event.data.type) {
            case 'STATBS21D_NAVIGATE':
            case 'NAVIGATE':
                if (event.data.url) {
                    handleNavigation(event.data.url);
                }
                break;
                
            case 'RESIZE_IFRAME':
                if (currentIframe && event.data.height) {
                    currentIframe.style.height = event.data.height + 'px';
                }
                break;
                
            case 'SHOW_LOADER':
                const loader = document.getElementById('loader');
                if (loader) loader.classList.remove('hidden');
                break;
                
            case 'HIDE_LOADER':
                const loader2 = document.getElementById('loader');
                if (loader2) loader2.classList.add('hidden');
                break;
                
            case 'REPORT_ERROR':
                console.error('Error reported from iframe:', event.data.message);
                const errorMsg = document.getElementById('error-message');
                if (errorMsg) errorMsg.style.display = 'block';
                break;
        }
    });
    
    function retryLoad() {
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const content = document.getElementById('content');
        
        if (errorMessage) errorMessage.style.display = 'none';
        if (loader) loader.classList.remove('hidden');
        if (content) content.classList.remove('visible');
        
        if (currentIframe && currentIframe.parentNode) {
            currentIframe.parentNode.removeChild(currentIframe);
            currentIframe = null;
        }
        
        setTimeout(init, 500);
    }
    
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden && currentIframe) {
            currentIframe.style.height = '100%';
        }
    });
    
    window.addEventListener('resize', function() {
        if (currentIframe) {
            try {
                currentIframe.contentWindow.postMessage({
                    type: 'PARENT_RESIZED',
                    width: window.innerWidth,
                    height: window.innerHeight
                }, iframeDomain);
            } catch (error) {
                // Cross-origin restriction
            }
        }
    });
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
        }
        
        #content { 
            width: 100%; 
            height: 100%; 
        }
        
        #live-iframe { 
            width: 100%; 
            height: 100%; 
            border: none; 
        }
        
        #loader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: white; 
            z-index: 9999; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
        }
        
        #loader.hidden { 
            display: none; 
        }
        
        .error-message { 
            display: none; 
            padding: 20px; 
            text-align: center; 
            color: #d32f2f; 
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid #d32f2f;
            border-radius: 5px;
            z-index: 10000;
        }
    `;
    document.head.appendChild(style);
</script>
       <div style="max-height: 400px; overflow-y: auto; padding: 16px;">
                    <div style="text-align: center; color: #666;">
                        <p>Facebook feed would appear here</p>
                        <p><small>External widgets are loaded in parent window due to cross-origin restrictions</small></p>
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(feedContainer);
        
        // Add toggle button
        const toggleBtn = document.createElement('button');
        toggleBtn.innerHTML = 'f';
        toggleBtn.style.cssText = `
            position: fixed; bottom: 20px; right: 20px; 
            background: #1877f2; color: white; border: none; 
            border-radius: 50%; width: 60px; height: 60px; 
            cursor: pointer; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center; 
            font-size: 24px; font-weight: bold;
        `;
        toggleBtn.onclick = function() {
            const feed = document.getElementById('parent-facebook-feed').firstElementChild;
            feed.style.display = feed.style.display === 'none' ? 'block' : 'none';
        };
        document.body.appendChild(toggleBtn);
    }
    
    function loadElfsightPlatform() {
        // Load Elfsight platform script in parent window
        if (!document.querySelector('script[src*="elfsight"]')) {
            const script = document.createElement('script');
            script.src = 'https://static.elfsight.com/platform/platform.js';
            script.async = true;
            script.onload = function() {
                console.log('Elfsight platform loaded in parent window');
            };
            document.head.appendChild(script);
        }
        
        // Add Elfsight widget container to parent
        if (!document.querySelector('.elfsight-app-b4e56e8c-d99d-4b4b-a65c-765264b4a35d')) {
            const widgetContainer = document.createElement('div');
            widgetContainer.className = 'elfsight-app-b4e56e8c-d99d-4b4b-a65c-765264b4a35d';
            widgetContainer.setAttribute('data-elfsight-app-lazy', '');
            widgetContainer.style.cssText = `
                position: fixed !important;
                bottom: 90px !important;
                right: 20px !important;
                z-index: 10000 !important;
                max-width: 340px !important;
            `;
            document.body.appendChild(widgetContainer);
        }
    }
    
    function fixIframeTables() {
        // Send postMessage to iframe to fix responsive tables
        // This only works if the iframe has a listener for this message
        try {
            currentIframe.contentWindow.postMessage({
                type: 'FIX_RESPONSIVE_TABLES',
                css: `
                    .table-responsive { 
                        width: 100% !important; 
                        max-width: 100% !important; 
                        overflow-x: auto !important; 
                    }
                    .table-responsive table { 
                        width: 100% !important; 
                        max-width: 100% !important; 
                        table-layout: auto !important; 
                    }
                    body { 
                        overflow-x: hidden !important; 
                        max-width: 100% !important; 
                    }
                `
            }, iframeDomain);
        } catch (error) {
            console.log('Cannot send postMessage to iframe');
        }
    }
    
    // Consolidated message listener
    window.addEventListener('message', function(event) {
        // For security, verify origin if possible
        // if (event.origin !== iframeDomain) return;
        
        switch (event.data.type) {
            case 'STATBS21D_NAVIGATE':
                console.log('StatBS21D navigation requested:', event.data.url);
                window.location.href = event.data.url;
                break;
                
            case 'NAVIGATE':
                console.log('Navigation requested:', event.data.url);
                window.location.href = event.data.url;
                break;
                
            case 'RESIZE_IFRAME':
                console.log('Resize requested:', event.data.height);
                if (currentIframe && event.data.height) {
                    currentIframe.style.height = event.data.height + 'px';
                }
                break;
                
            case 'SHOW_LOADER':
                document.getElementById('loader').classList.remove('hidden');
                break;
                
            case 'HIDE_LOADER':
                document.getElementById('loader').classList.add('hidden');
                break;
        }
    });
    
    function retryLoad() {
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const content = document.getElementById('content');
        
        errorMessage.style.display = 'none';
        loader.classList.remove('hidden');
        content.classList.remove('visible');
        
        // Clean up existing widgets
        const existingFeed = document.getElementById('parent-facebook-feed');
        const existingToggle = document.querySelector('button[style*="position: fixed"][style*="bottom: 20px"]');
        if (existingFeed) existingFeed.remove();
        if (existingToggle) existingToggle.remove();
        
        if (currentIframe && currentIframe.parentNode) {
            currentIframe.parentNode.removeChild(currentIframe);
        }
        
        setTimeout(init, 500);
    }
    
    // Handle browser back/forward buttons
    window.addEventListener('popstate', function(event) {
        if (event.state && event.state.iframeUrl) {
            currentIframe.src = event.state.iframeUrl;
        }
    });
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    // CSS for loader animation and general styles
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ensure iframe takes full space */
        #content { width: 100%; height: 100%; }
        #live-iframe { width: 100%; height: 100%; border: none; }
        
        /* Loader styles */
        #loader { 
            position: fixed; top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: white; z-index: 9999; 
            display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
        }
        #loader.hidden { display: none; }
        
        /* Error message styles */
        .error-message { 
            display: none; padding: 20px; 
            text-align: center; color: #d32f2f; 
        }
    `;
    document.head.appendChild(style);
</script>
</body>
</html>