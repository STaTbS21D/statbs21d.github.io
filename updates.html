<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title id="page-title">STaTbS21D - Live Updates</title>
    <meta name="description" content="Synoptic Edition of Book of the Dead Spell Sources from the 21st Dynasty (STaTbS21D) is a Digital Humanities project on Egyptology">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
        }
        
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #fff;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #loader.hidden {
            display: none;
        }
        
        #content {
            width: 100%;
            height: 100%;
            display: none;
        }
        
        #content.visible {
            display: block;
        }
        
        #live-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .error-message {
            display: none;
            padding: 20px;
            text-align: center;
            color: #d32f2f;
        }
        
    </style>
</head>

<body>
    <div id="loader">
        <div style="text-align: center;">
            <img src="assets/img/loading.gif" alt="Loading..." style="display: block;margin: auto;">
            <p>Loading...</p>
        </div>
    </div>

    <div class="error-message" id="error-message">
        <h3>Connection Error</h3>
        <p>Unable to load the content. Please check your connection and try again.</p>
        <button onclick="retryLoad()">Retry</button>
    </div>

    <div id="content">
        <!-- Iframe will be placed here -->
    </div>

    <script>
    let currentIframe = null;
    const targetDomain = 'https://statbs21d.github.io';
    
    function init() {
        console.log('Initializing iframe...');
        
        const loader = document.getElementById('loader');
        const content = document.getElementById('content');
        const errorMessage = document.getElementById('error-message');
        
        currentIframe = document.createElement('iframe');
        currentIframe.id = 'live-iframe';
        currentIframe.src = 'https://mdc2unicode.x10.bz/statbs21d/public.php';
        currentIframe.sandbox = "allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox";
        
        currentIframe.onload = function() {
            console.log('Iframe loaded successfully');
            loader.classList.add('hidden');
            content.classList.add('visible');
            errorMessage.style.display = 'none';
            injectDomainLinkHandler();
            handleExternalWidgets();
        };
        
        currentIframe.onerror = function() {
            console.error('Iframe failed to load');
            loader.classList.add('hidden');
            errorMessage.style.display = 'block';
        };
        
        content.appendChild(currentIframe);
    }
    
    function injectDomainLinkHandler() {
        try {
            const iframeDoc = currentIframe.contentDocument || currentIframe.contentWindow.document;
            const script = iframeDoc.createElement('script');
            script.textContent = `
                document.addEventListener('click', function(e) {
                    let target = e.target;
                    while (target && target.tagName !== 'A') {
                        target = target.parentElement;
                        if (!target) return;
                    }
                    if (target && target.href) {
                        const href = target.href;
                        if (href.includes('statbs21d.github.io') || 
                            href.startsWith('/') || 
                            (!href.startsWith('http') && !href.startsWith('//') && !href.startsWith('mailto:') && !href.startsWith('tel:') && !href.startsWith('javascript:') && !href.startsWith('#'))) {
                            e.preventDefault();
                            e.stopPropagation();
                            let absoluteUrl = href;
                            if (href.startsWith('/')) {
                                absoluteUrl = '${targetDomain}' + href;
                            } else if (!href.startsWith('http')) {
                                absoluteUrl = '${targetDomain}/' + href;
                            }
                            window.parent.postMessage({
                                type: 'STATBS21D_NAVIGATE',
                                url: absoluteUrl
                            }, '*');
                        }
                    }
                });
            `;
            iframeDoc.head.appendChild(script);
            console.log('Domain-specific link handler injected');
        } catch (error) {
            console.log('Cannot inject link handler (cross-origin):', error);
        }
    }
    
    function handleExternalWidgets() {
        try {
            setTimeout(() => {
                const iframeDoc = currentIframe.contentDocument || currentIframe.contentWindow.document;
                const elfSightScripts = iframeDoc.querySelectorAll('script[src*="elfsight"]');
                elfSightScripts.forEach(script => script.remove());
                
                const elfSightWidgets = iframeDoc.querySelectorAll('[class*="elfsight"], [data-elfsight-app]');
                elfSightWidgets.forEach(widget => {
                    widget.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">Facebook feed available in the bottom-right corner</div>';
                });
                
                const facebookIframes = iframeDoc.querySelectorAll('iframe[src*="facebook"]');
                facebookIframes.forEach(frame => frame.style.display = 'none');
            }, 1000);
        } catch (error) {
            console.log('Cannot modify iframe content due to cross-origin restrictions');
        }
    }
    
    window.addEventListener('message', function(event) {
        if (event.data.type === 'STATBS21D_NAVIGATE') {
            console.log('StatBS21D navigation requested:', event.data.url);
            window.location.href = event.data.url;
        } else if (event.data.type === 'NAVIGATE') {
            console.log('Navigation requested:', event.data.url);
            window.location.href = event.data.url;
        }
    });
    
    function retryLoad() {
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const content = document.getElementById('content');
        
        errorMessage.style.display = 'none';
        loader.classList.remove('hidden');
        content.classList.remove('visible');
        
        if (currentIframe && currentIframe.parentNode) {
            currentIframe.parentNode.removeChild(currentIframe);
        }
        
        setTimeout(init, 500);
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    
    const style = document.createElement('style');
    style.textContent = `@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}`;
    document.head.appendChild(style);
</script>
</body>
</html>